(()=>{var I=Object.defineProperty;var b=Object.prototype.hasOwnProperty;var y=Object.getOwnPropertySymbols,k=Object.prototype.propertyIsEnumerable;var f=(e,t,n)=>t in e?I(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,u=(e,t)=>{for(var n in t||(t={}))b.call(t,n)&&f(e,n,t[n]);if(y)for(var n of y(t))k.call(t,n)&&f(e,n,t[n]);return e};var l={audioIn:null},m="/test/",C={video:{width:{ideal:640},height:{ideal:480},frameRate:{ideal:30},facingMode:{ideal:"user"}},audio:{sampleSize:16,autoGainControl:!1,channelCount:1,latency:{ideal:.003},echoCancellation:!1,noiseSuppression:!1}},B={iceServers:[{urls:"stun:stun.l.google.com:19302"}]},w=e=>{let n=window.location.search.substring(1).split("&");for(let d=0;d<n.length;d++){let c=n[d].split("=");if(decodeURIComponent(c[0])==e)return decodeURIComponent(c[1])}},O=async()=>{let e=w("room"),t=w("name");(!e||!t)&&(window.location.href=m),window.history.replaceState({},document.title,`${m}live/`),l.room=e,l.name=t;try{let n=await navigator.mediaDevices.enumerateDevices(),d=document.getElementById("audio-select");for(let c=0;c!==n.length;++c){let s=n[c];if(s.kind==="audioinput"){let o=document.createElement("li"),a=document.createElement("a");a.href="#",a.text=s.label||`microphone ${audioInputSelect.length+1}`,a.addEventListener("click",()=>{l.audioIn=s.deviceId,document.getElementById("audio-in-label").textContent=s.label}),o.appendChild(a),d.appendChild(o)}}}catch(n){console.error(n)}},R=e=>window.navigator.userAgent.includes("Mozilla")?e.split(`\r
`).map(t=>t.startsWith("a=fmtp:111")?t.replace("stereo=1","stereo=0"):t).join(`\r
`):e,N=e=>R(e),D=()=>Math.random().toString(36).replace(/[^a-z]+/g,"").substr(0,8),T=async()=>{document.getElementById("start-container").classList.add("hide"),document.getElementById("stop-container").classList.remove("hide");let e=new RTCPeerConnection(B),t=u({},C);l.audioIn&&(t.audio=u(u({},t.audio),{deviceId:{ideal:l.audioIn}}));let n=await navigator.mediaDevices.getUserMedia(t),d=document.getElementById("local-video");d.srcObject=n,n.getTracks().forEach(o=>e.addTrack(o,n));let c=window.location.protocol==="https:"?"wss":"ws",s=new WebSocket(`${c}://${window.location.host}/ws`);s.onopen=function(){let{name:o,room:a}=l;s.send(JSON.stringify({type:"join",payload:JSON.stringify({name:o,room:a,proc:!0,uid:D()})}))},s.onclose=function(o){console.log("Websocket has closed")},s.onerror=function(o){console.error("ws: "+o.data)},s.onmessage=async function(o){let a=JSON.parse(o.data);if(!a)return console.error("failed to parse msg");switch(a.type){case"offer":{let i=JSON.parse(a.payload);if(!i)return console.error("failed to parse answer");e.setRemoteDescription(i);let r=await e.createAnswer();r.sdp=N(r.sdp),e.setLocalDescription(r),s.send(JSON.stringify({type:"answer",payload:JSON.stringify(r)}));break}case"candidate":{let i=JSON.parse(a.payload);if(!i)return console.error("failed to parse candidate");e.addIceCandidate(i);break}case"stop":{window.location.href=`${m}end/`;break}case"error":{window.location.href=`${m}full/`;break}}},e.onicecandidate=o=>{!o.candidate||s.send(JSON.stringify({type:"candidate",payload:JSON.stringify(o.candidate)}))},e.ontrack=function(o){let a=document.createElement(o.track.kind);a.id=o.track.id,a.srcObject=o.streams[0],a.autoplay=!0,document.getElementById("remote").appendChild(a),o.streams[0].onremovetrack=({track:i})=>{let r=document.getElementById(i.id);r&&r.parentNode.removeChild(r)}},setInterval(()=>L(e),1e3)},g=Date.now(),v=0,h=0,S=0,E=0,p=(e,t,n)=>(8*e/t/1024).toFixed(1),L=async e=>{let t=await e.getStats(),n=Date.now(),d=0,c=0,s=0,o=0;t.forEach(i=>{i.type==="outbound-rtp"&&i.kind==="audio"?d+=i.bytesSent:i.type==="inbound-rtp"&&i.kind==="audio"?c+=i.bytesReceived:i.type==="outbound-rtp"&&i.kind==="video"?s+=i.bytesSent:i.type==="inbound-rtp"&&i.kind==="video"&&(o+=i.bytesReceived)});let a=(n-g)/1e3;document.getElementById("audio-up").textContent=p(d-v,a),document.getElementById("audio-down").textContent=p(c-h,a),document.getElementById("video-up").textContent=p(s-S,a),document.getElementById("video-down").textContent=p(o-E,a),g=n,v=d,h=c,S=s,E=o};document.addEventListener("DOMContentLoaded",O);document.addEventListener("DOMContentLoaded",()=>{let e=document.querySelectorAll(".dropdown-trigger"),t=M.Dropdown.init(e,{constrainWidth:!1});document.getElementById("start").addEventListener("click",T),document.getElementById("stop").addEventListener("click",()=>location.reload())});})();
