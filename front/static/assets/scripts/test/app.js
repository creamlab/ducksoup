(()=>{var b=Object.defineProperty,k=Object.defineProperties;var C=Object.getOwnPropertyDescriptors;var y=Object.getOwnPropertySymbols;var B=Object.prototype.hasOwnProperty,O=Object.prototype.propertyIsEnumerable;var f=(e,t,n)=>t in e?b(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,p=(e,t)=>{for(var n in t||(t={}))B.call(t,n)&&f(e,n,t[n]);if(y)for(var n of y(t))O.call(t,n)&&f(e,n,t[n]);return e},w=(e,t)=>k(e,C(t));var l={audioIn:null},u="/test/",R={video:{width:{ideal:640},height:{ideal:480},frameRate:{ideal:30},facingMode:{ideal:"user"}},audio:{sampleSize:16,autoGainControl:!1,channelCount:1,latency:{ideal:.003},echoCancellation:!1,noiseSuppression:!1}},N={iceServers:[{urls:"stun:stun.l.google.com:19302"}]},g=e=>{let n=window.location.search.substring(1).split("&");for(let d=0;d<n.length;d++){let c=n[d].split("=");if(decodeURIComponent(c[0])==e)return decodeURIComponent(c[1])}},D=async()=>{let e=g("room"),t=g("name");(!e||!t)&&(window.location.href=u),window.history.replaceState({},document.title,`${u}live/`),l.room=e,l.name=t;try{let n=await navigator.mediaDevices.enumerateDevices(),d=document.getElementById("audio-select");for(let c=0;c!==n.length;++c){let s=n[c];if(s.kind==="audioinput"){let o=document.createElement("li"),a=document.createElement("a");a.href="#",a.text=s.label||`microphone ${audioInputSelect.length+1}`,a.addEventListener("click",()=>{l.audioIn=s.deviceId,document.getElementById("audio-in-label").textContent=s.label}),o.appendChild(a),d.appendChild(o)}}}catch(n){console.error(n)}},L=e=>window.navigator.userAgent.includes("Mozilla")?e.split(`\r
`).map(t=>t.startsWith("a=fmtp:111")?t.replace("stereo=1","stereo=0"):t).join(`\r
`):e,T=e=>L(e),A=()=>Math.random().toString(36).replace(/[^a-z]+/g,"").substr(0,8),x=async()=>{document.getElementById("start-container").classList.add("hide"),document.getElementById("stop-container").classList.remove("hide");let e=new RTCPeerConnection(N),t=p({},R);l.audioIn&&(t.audio=w(p({},t.audio),{deviceId:{ideal:l.audioIn}}));let n=await navigator.mediaDevices.getUserMedia(t),d=document.getElementById("local-video");d.srcObject=n,n.getTracks().forEach(o=>e.addTrack(o,n));let c=window.location.protocol==="https:"?"wss":"ws",s=new WebSocket(`${c}://${window.location.host}/ws`);s.onopen=function(){let{name:o,room:a}=l;s.send(JSON.stringify({type:"join",payload:JSON.stringify({name:o,room:a,proc:!0,uid:A()})}))},s.onclose=function(o){console.log("Websocket has closed")},s.onerror=function(o){console.error("ws: "+o.data)},s.onmessage=async function(o){let a=JSON.parse(o.data);if(!a)return console.error("failed to parse msg");switch(a.type){case"offer":{let i=JSON.parse(a.payload);if(!i)return console.error("failed to parse answer");e.setRemoteDescription(i);let r=await e.createAnswer();r.sdp=T(r.sdp),e.setLocalDescription(r),s.send(JSON.stringify({type:"answer",payload:JSON.stringify(r)}));break}case"candidate":{let i=JSON.parse(a.payload);if(!i)return console.error("failed to parse candidate");e.addIceCandidate(i);break}case"stop":{window.location.href=`${u}end/`;break}case"error":{window.location.href=`${u}full/`;break}}},e.onicecandidate=o=>{!o.candidate||s.send(JSON.stringify({type:"candidate",payload:JSON.stringify(o.candidate)}))},e.ontrack=function(o){let a=document.createElement(o.track.kind);a.id=o.track.id,a.srcObject=o.streams[0],a.autoplay=!0,document.getElementById("remote").appendChild(a),o.streams[0].onremovetrack=({track:i})=>{let r=document.getElementById(i.id);r&&r.parentNode.removeChild(r)}},setInterval(()=>J(e),1e3)},v=Date.now(),h=0,S=0,E=0,I=0,m=(e,t,n)=>(8*e/t/1024).toFixed(1),J=async e=>{let t=await e.getStats(),n=Date.now(),d=0,c=0,s=0,o=0;t.forEach(i=>{i.type==="outbound-rtp"&&i.kind==="audio"?d+=i.bytesSent:i.type==="inbound-rtp"&&i.kind==="audio"?c+=i.bytesReceived:i.type==="outbound-rtp"&&i.kind==="video"?s+=i.bytesSent:i.type==="inbound-rtp"&&i.kind==="video"&&(o+=i.bytesReceived)});let a=(n-v)/1e3;document.getElementById("audio-up").textContent=m(d-h,a),document.getElementById("audio-down").textContent=m(c-S,a),document.getElementById("video-up").textContent=m(s-E,a),document.getElementById("video-down").textContent=m(o-I,a),v=n,h=d,S=c,E=s,I=o};document.addEventListener("DOMContentLoaded",D);document.addEventListener("DOMContentLoaded",()=>{let e=document.querySelectorAll(".dropdown-trigger"),t=M.Dropdown.init(e,{constrainWidth:!1});document.getElementById("start").addEventListener("click",x),document.getElementById("stop").addEventListener("click",()=>location.reload())});})();
