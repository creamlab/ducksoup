(()=>{var v=Object.defineProperty;var u=Object.getOwnPropertySymbols;var h=Object.prototype.hasOwnProperty,C=Object.prototype.propertyIsEnumerable;var f=(e,t,n)=>t in e?v(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,l=(e,t)=>{for(var n in t||(t={}))h.call(t,n)&&f(e,n,t[n]);if(u)for(var n of u(t))C.call(t,n)&&f(e,n,t[n]);return e};var c={},m={video:{width:{ideal:640},height:{ideal:480},frameRate:{ideal:30},facingMode:{ideal:"user"}},audio:{sampleSize:16,autoGainControl:!1,channelCount:1,latency:{ideal:.003},echoCancellation:!1,noiseSuppression:!1}},T={iceServers:[{urls:"stun:stun.l.google.com:19302"}]},g=window.RTCRtpTransceiver&&"setCodecPreferences"in window.RTCRtpTransceiver.prototype,S=(e,t)=>{let a=window.location.search.substring(1).split("&");for(let s=0;s<a.length;s++){let o=a[s].split("=");if(decodeURIComponent(o[0])==e){let r=decodeURIComponent(o[1]);return t?t(r):r}}},E=e=>{try{return JSON.parse(atob(decodeURI(e)))}catch(t){return console.log(t),null}},N=async()=>{await navigator.mediaDevices.getUserMedia({audio:!0,video:!0});let e=await navigator.mediaDevices.enumerateDevices(),t=document.getElementById("audio-source"),n=document.getElementById("video-source");for(let a=0;a!==e.length;++a){let s=e[a],o=document.createElement("option");o.value=s.deviceId,s.kind==="audioinput"?(o.text=s.label||`microphone ${t.length+1}`,t.appendChild(o)):s.kind==="videoinput"&&(o.text=s.label||`camera ${n.length+1}`,n.appendChild(o))}},O=e=>{window.parent&&window.parent.postMessage(e,window.location.origin)},R=({room:e,name:t,proc:n,duration:a,uid:s})=>typeof e!="undefined"&&typeof s!="undefined"&&typeof t!="undefined"&&typeof n!="undefined"&&!isNaN(a),k=async()=>{let e=E(S("params"));if(!R(e))document.getElementById("placeholder").innerHTML="Invalid parameters";else{if(g&&e.h264){let{codecs:t}=RTCRtpSender.getCapabilities("video");c.preferredCodecs=[...t].sort(({mimeType:n},{mimeType:a})=>n.includes("264")?-1:a.includes("264")?1:0)}c=l(l({},c),e);try{await N(),await I()}catch(t){console.error(t),p("error")}}},D=e=>window.navigator.userAgent.includes("Mozilla")?e.split(`\r
`).map(t=>t.startsWith("a=fmtp:111")?t.replace("stereo=1","stereo=0"):t).join(`\r
`):e,P=e=>D(e),p=e=>{let t=typeof e=="string"?{type:e}:e;c.stream.getTracks().forEach(n=>n.stop()),O(t)},I=async()=>{let e=new RTCPeerConnection(T),t={audio:l(l({},m.audio),c.audio),video:l(l({},m.video),c.video)},n=await navigator.mediaDevices.getUserMedia(t);n.getTracks().forEach(o=>e.addTrack(o,n)),c.stream=n,g&&c.h264&&e.getTransceivers().find(r=>r.sender&&r.sender.track===n.getVideoTracks()[0]).setCodecPreferences(c.preferredCodecs);let a=window.location.protocol==="https:"?"wss":"ws",s=new WebSocket(`${a}://${window.location.host}/ws`);s.onopen=function(){let{room:o,name:r,proc:d,duration:i,uid:y,h264:w}=c;s.send(JSON.stringify({type:"join",payload:JSON.stringify({room:o,name:r,duration:i,uid:y,proc:d,h264:w})}))},s.onclose=function(o){console.log("[ws] closed"),p("disconnected")},s.onerror=function(o){console.error("[ws] error: "+o.data),p("error")},s.onmessage=async function(o){let r=JSON.parse(o.data);if(!r)return console.error("[ws] can't parse message");if(r.type==="offer"){let d=JSON.parse(r.payload);if(!d)return console.error("[ws] can't parse offer");console.log("[ws] received offer"),e.setRemoteDescription(d);let i=await e.createAnswer();i.sdp=P(i.sdp),e.setLocalDescription(i),s.send(JSON.stringify({type:"answer",payload:JSON.stringify(i)}))}else if(r.type==="candidate"){let d=JSON.parse(r.payload);if(!d)return console.error("[ws] can't parse candidate");console.log("[ws] candidate"),e.addIceCandidate(d)}else r.type==="start"?console.log("[ws] start"):r.type==="finishing"?(console.log("[ws] finishing"),document.getElementById("finishing").classList.remove("d-none")):(r.type.startsWith("error")||r.type==="finish")&&p(r)},e.onicecandidate=o=>{!o.candidate||s.send(JSON.stringify({type:"candidate",payload:JSON.stringify(o.candidate)}))},e.ontrack=function(o){let r=document.createElement(o.track.kind);r.id=o.track.id,r.srcObject=o.streams[0],r.autoplay=!0,document.getElementById("placeholder").appendChild(r),o.streams[0].onremovetrack=({track:d})=>{let i=document.getElementById(d.id);i&&i.parentNode.removeChild(i)}}};document.addEventListener("DOMContentLoaded",k);})();
