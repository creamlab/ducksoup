(()=>{var v=Object.defineProperty,h=Object.defineProperties;var I=Object.getOwnPropertyDescriptors;var m=Object.getOwnPropertySymbols;var S=Object.prototype.hasOwnProperty,D=Object.prototype.propertyIsEnumerable;var g=(e,o,n)=>o in e?v(e,o,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[o]=n,u=(e,o)=>{for(var n in o||(o={}))S.call(o,n)&&g(e,n,o[n]);if(m)for(var n of m(o))D.call(o,n)&&g(e,n,o[n]);return e},p=(e,o)=>h(e,I(o));var d={audioIn:null},E={video:{width:{ideal:640},height:{ideal:480},frameRate:{ideal:30},facingMode:{ideal:"user"}},audio:{sampleSize:16,autoGainControl:!1,channelCount:1,latency:{ideal:.003},echoCancellation:!1,noiseSuppression:!1}},C={iceServers:[{urls:"stun:stun.l.google.com:19302"}]},l=e=>{let n=window.location.search.substring(1).split("&");for(let s=0;s<n.length;s++){let i=n[s].split("=");if(decodeURIComponent(i[0])==e)return decodeURIComponent(i[1])}},N=async()=>{await navigator.mediaDevices.getUserMedia({audio:!0,video:!0});let e=await navigator.mediaDevices.enumerateDevices(),o=document.getElementById("audio-source"),n=document.getElementById("video-source");for(let s=0;s!==e.length;++s){let i=e[s],t=document.createElement("option");t.value=i.deviceId,i.kind==="audioinput"?(t.text=i.label||`microphone ${o.length+1}`,o.appendChild(t)):i.kind==="videoinput"&&(t.text=i.label||`camera ${n.length+1}`,n.appendChild(t))}},O=e=>{window.parent&&window.parent.postMessage(e,window.location.origin)},k=async()=>{let e=l("room"),o=l("name"),n=l("proc"),s=parseInt(l("duration"),10),i=l("uid"),t=l("aid"),a=l("vid");if(typeof e=="undefined"||typeof o=="undefined"||!["0","1"].includes(n)||isNaN(s)||typeof i=="undefined")document.getElementById("placeholder").innerHTML="Invalid parameters";else{d=p(u({},d),{room:e,name:o,proc:n,duration:s,uid:i,audioDeviceId:t,videoDeviceId:a});try{await N(),await T()}catch(r){console.error(r),f("error")}}},J=e=>window.navigator.userAgent.includes("Mozilla")?e.split(`\r
`).map(o=>o.startsWith("a=fmtp:111")?o.replace("stereo=1","stereo=0"):o).join(`\r
`):e,M=e=>J(e),f=e=>{d.stream.getTracks().forEach(o=>o.stop()),O(e)},T=async()=>{let e=new RTCPeerConnection(C),o=u({},E);d.audioDeviceId&&(o.audio=p(u({},o.audio),{deviceId:{ideal:d.audioDeviceId}})),d.videoDeviceId&&(o.video=p(u({},o.video),{deviceId:{ideal:d.videoDeviceId}}));let n=await navigator.mediaDevices.getUserMedia(o);n.getTracks().forEach(t=>e.addTrack(t,n)),d.stream=n;let s=window.location.protocol==="https:"?"wss":"ws",i=new WebSocket(`${s}://${window.location.host}/ws`);i.onopen=function(){let{room:t,name:a,proc:r,duration:c,uid:w}=d,y=Boolean(parseInt(r));i.send(JSON.stringify({type:"join",payload:JSON.stringify({room:t,name:a,duration:c,uid:w,proc:y})}))},i.onclose=function(t){console.log("[ws] closed"),f("disconnected")},i.onerror=function(t){console.error("[ws] error: "+t.data),f("error")},i.onmessage=async function(t){let a=JSON.parse(t.data);if(!a)return console.error("[ws] can't parse message");if(a.type==="offer"){let r=JSON.parse(a.payload);if(!r)return console.error("[ws] can't parse offer");console.log("[ws] received offer"),e.setRemoteDescription(r);let c=await e.createAnswer();c.sdp=M(c.sdp),e.setLocalDescription(c),i.send(JSON.stringify({type:"answer",payload:JSON.stringify(c)}))}else if(a.type==="candidate"){let r=JSON.parse(a.payload);if(!r)return console.error("[ws] can't parse candidate");console.log("[ws] candidate"),e.addIceCandidate(r)}else a.type==="start"?console.log("[ws] start"):a.type==="finishing"?(console.log("[ws] finishing"),document.getElementById("finishing").classList.remove("d-none")):(a.type.startsWith("error")||a.type==="finish")&&f(a.type)},e.onicecandidate=t=>{!t.candidate||i.send(JSON.stringify({type:"candidate",payload:JSON.stringify(t.candidate)}))},e.ontrack=function(t){let a=document.createElement(t.track.kind);a.id=t.track.id,a.srcObject=t.streams[0],a.autoplay=!0,document.getElementById("placeholder").appendChild(a),t.streams[0].onremovetrack=({track:r})=>{let c=document.getElementById(r.id);c&&c.parentNode.removeChild(c)}}};document.addEventListener("DOMContentLoaded",k);})();
