(()=>{var v=Object.defineProperty;var w=Object.prototype.hasOwnProperty;var f=Object.getOwnPropertySymbols,h=Object.prototype.propertyIsEnumerable;var m=(e,t,n)=>t in e?v(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,l=(e,t)=>{for(var n in t||(t={}))w.call(t,n)&&m(e,n,t[n]);if(f)for(var n of f(t))h.call(t,n)&&m(e,n,t[n]);return e};var c={audioIn:null},I={video:{width:{ideal:640},height:{ideal:480},frameRate:{ideal:30},facingMode:{ideal:"user"}},audio:{sampleSize:16,autoGainControl:!1,channelCount:1,latency:{ideal:.003},echoCancellation:!1,noiseSuppression:!1}},S={iceServers:[{urls:"stun:stun.l.google.com:19302"}]},u=e=>{let n=window.location.search.substring(1).split("&");for(let s=0;s<n.length;s++){let i=n[s].split("=");if(decodeURIComponent(i[0])==e)return decodeURIComponent(i[1])}},D=async()=>{await navigator.mediaDevices.getUserMedia({audio:!0,video:!0});let e=await navigator.mediaDevices.enumerateDevices(),t=document.getElementById("audio-source"),n=document.getElementById("video-source");for(let s=0;s!==e.length;++s){let i=e[s],o=document.createElement("option");o.value=i.deviceId,i.kind==="audioinput"?(o.text=i.label||`microphone ${t.length+1}`,t.appendChild(o)):i.kind==="videoinput"&&(o.text=i.label||`camera ${n.length+1}`,n.appendChild(o))}},E=e=>{window.parent&&window.parent.postMessage(e,window.location.origin)},N=async()=>{let e=u("room"),t=u("name"),n=u("proc"),s=parseInt(u("duration"),10),i=u("uid"),o=u("aid"),a=u("vid");if(typeof e=="undefined"||typeof t=="undefined"||!["0","1"].includes(n)||isNaN(s)||typeof i=="undefined")document.getElementById("placeholder").innerHTML="Invalid parameters";else{c=l(l({},c),{room:e,name:t,proc:n,duration:s,uid:i,audioDeviceId:o,videoDeviceId:a});try{await D(),await C()}catch(r){console.error(r),p("error")}}},O=e=>window.navigator.userAgent.includes("Mozilla")?e.split(`\r
`).map(t=>t.startsWith("a=fmtp:111")?t.replace("stereo=1","stereo=0"):t).join(`\r
`):e,k=e=>O(e),p=e=>{c.stream.getTracks().forEach(t=>t.stop()),E(e)},C=async()=>{let e=new RTCPeerConnection(S),t=l({},I);c.audioDeviceId&&(t.audio=l(l({},t.audio),{deviceId:{ideal:c.audioDeviceId}})),c.videoDeviceId&&(t.video=l(l({},t.video),{deviceId:{ideal:c.videoDeviceId}}));let n=await navigator.mediaDevices.getUserMedia(t);n.getTracks().forEach(o=>e.addTrack(o,n)),c.stream=n;let s=window.location.protocol==="https:"?"wss":"ws",i=new WebSocket(`${s}://${window.location.host}/ws`);i.onopen=function(){let{room:o,name:a,proc:r,duration:d,uid:y}=c,g=Boolean(parseInt(r));i.send(JSON.stringify({type:"join",payload:JSON.stringify({room:o,name:a,duration:d,uid:y,proc:g})}))},i.onclose=function(o){console.log("Websocket has closed"),p("disconnected")},i.onerror=function(o){console.error("ws: "+o.data),p("error")},i.onmessage=async function(o){let a=JSON.parse(o.data);if(!a)return console.error("failed to parse msg");if(a.type==="offer"){let r=JSON.parse(a.payload);if(!r)return console.error("failed to parse answer");e.setRemoteDescription(r);let d=await e.createAnswer();d.sdp=k(d.sdp),e.setLocalDescription(d),i.send(JSON.stringify({type:"answer",payload:JSON.stringify(d)}))}else if(a.type==="candidate"){let r=JSON.parse(a.payload);if(!r)return console.error("failed to parse candidate");e.addIceCandidate(r)}else a.type==="start"?console.log("start"):a.type==="finishing"?document.getElementById("finishing").classList.remove("d-none"):(a.type.startsWith("error")||a.type==="finish")&&p(a.type)},e.onicecandidate=o=>{!o.candidate||i.send(JSON.stringify({type:"candidate",payload:JSON.stringify(o.candidate)}))},e.ontrack=function(o){let a=document.createElement(o.track.kind);a.id=o.track.id,a.srcObject=o.streams[0],a.autoplay=!0,document.getElementById("placeholder").appendChild(a),o.streams[0].onremovetrack=({track:r})=>{let d=document.getElementById(r.id);d&&d.parentNode.removeChild(d)}}};document.addEventListener("DOMContentLoaded",N);})();
