(()=>{var v=Object.defineProperty;var y=Object.prototype.hasOwnProperty;var p=Object.getOwnPropertySymbols,w=Object.prototype.propertyIsEnumerable;var f=(e,o,n)=>o in e?v(e,o,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[o]=n,d=(e,o)=>{for(var n in o||(o={}))y.call(o,n)&&f(e,n,o[n]);if(p)for(var n of p(o))w.call(o,n)&&f(e,n,o[n]);return e};var l={audioIn:null},h={video:{width:{ideal:640},height:{ideal:480},frameRate:{ideal:30},facingMode:{ideal:"user"}},audio:{sampleSize:16,autoGainControl:!1,channelCount:1,latency:{ideal:.003},echoCancellation:!1,noiseSuppression:!1}},I={iceServers:[{urls:"stun:stun.l.google.com:19302"}]},u=e=>{let n=window.location.search.substring(1).split("&");for(let r=0;r<n.length;r++){let a=n[r].split("=");if(decodeURIComponent(a[0])==e)return decodeURIComponent(a[1])}},D=async()=>{await navigator.mediaDevices.getUserMedia({audio:!0,video:!0});let e=await navigator.mediaDevices.enumerateDevices(),o=document.getElementById("audio-source"),n=document.getElementById("video-source");for(let r=0;r!==e.length;++r){let a=e[r],t=document.createElement("option");t.value=a.deviceId,a.kind==="audioinput"?(t.text=a.label||`microphone ${o.length+1}`,o.appendChild(t)):a.kind==="videoinput"&&(t.text=a.label||`camera ${n.length+1}`,n.appendChild(t))}},m=e=>{window.parent&&window.parent.postMessage(e,window.location.origin)},k=async()=>{let e=u("room"),o=u("name"),n=u("proc"),r=parseInt(u("duration"),10),a=u("uid"),t=u("aid"),s=u("vid");if(typeof e=="undefined"||typeof o=="undefined"||!["0","1"].includes(n)||isNaN(r)||typeof a=="undefined")document.getElementById("placeholder").innerHTML="Invalid parameters";else{l=d(d({},l),{room:e,name:o,proc:n,duration:r,uid:a,audioDeviceId:t,videoDeviceId:s});try{await D(),await S()}catch(i){console.error(i)}}},E=e=>window.navigator.userAgent.includes("Mozilla")?e.split(`\r
`).map(o=>o.startsWith("a=fmtp:111")?o.replace("stereo=1","stereo=0"):o).join(`\r
`):e,C=e=>E(e),S=async()=>{let e=new RTCPeerConnection(I),o=d({},h);l.audioDeviceId&&(o.audio=d(d({},o.audio),{deviceId:{ideal:l.audioDeviceId}})),l.videoDeviceId&&(o.video=d(d({},o.video),{deviceId:{ideal:l.videoDeviceId}}));let n=await navigator.mediaDevices.getUserMedia(o);n.getTracks().forEach(t=>e.addTrack(t,n));let r=window.location.protocol==="https:"?"wss":"ws",a=new WebSocket(`${r}://${window.location.host}/ws`);a.onopen=function(){let{room:t,name:s,proc:i,duration:c,uid:g}=l;a.send(JSON.stringify({type:"join",payload:JSON.stringify({room:t,name:s,proc:Boolean(i),duration:c,uid:g})}))},a.onclose=function(t){console.log("Websocket has closed")},a.onerror=function(t){console.error("ws: "+t.data)},a.onmessage=async function(t){let s=JSON.parse(t.data);if(!s)return console.error("failed to parse msg");switch(s.type){case"offer":{let i=JSON.parse(s.payload);if(!i)return console.error("failed to parse answer");e.setRemoteDescription(i);let c=await e.createAnswer();c.sdp=C(c.sdp),e.setLocalDescription(c),a.send(JSON.stringify({type:"answer",payload:JSON.stringify(c)}));break}case"candidate":{let i=JSON.parse(s.payload);if(!i)return console.error("failed to parse candidate");e.addIceCandidate(i);break}case"start":{let i=(l.duration-10)*1e3;i>0&&setTimeout(()=>{document.getElementById("finishing").classList.remove("d-none")},i);break}case"stop":{m("stop"),n.getTracks().forEach(i=>i.stop());break}case"error":{m("error");break}}},e.onicecandidate=t=>{!t.candidate||a.send(JSON.stringify({type:"candidate",payload:JSON.stringify(t.candidate)}))},e.ontrack=function(t){let s=document.createElement(t.track.kind);s.id=t.track.id,s.srcObject=t.streams[0],s.autoplay=!0,document.getElementById("placeholder").appendChild(s),t.streams[0].onremovetrack=({track:i})=>{let c=document.getElementById(i.id);c&&c.parentNode.removeChild(c)}}};document.addEventListener("DOMContentLoaded",k);})();
