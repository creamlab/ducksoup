(()=>{var C=Object.defineProperty,I=Object.defineProperties;var T=Object.getOwnPropertyDescriptors;var g=Object.getOwnPropertySymbols;var S=Object.prototype.hasOwnProperty,E=Object.prototype.propertyIsEnumerable;var v=(e,o,i)=>o in e?C(e,o,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[o]=i,p=(e,o)=>{for(var i in o||(o={}))S.call(o,i)&&v(e,i,o[i]);if(g)for(var i of g(o))E.call(o,i)&&v(e,i,o[i]);return e},f=(e,o)=>I(e,T(o));var c={audioIn:null},D={video:{width:{ideal:640},height:{ideal:480},frameRate:{ideal:30},facingMode:{ideal:"user"}},audio:{sampleSize:16,autoGainControl:!1,channelCount:1,latency:{ideal:.003},echoCancellation:!1,noiseSuppression:!1}},N={iceServers:[{urls:"stun:stun.l.google.com:19302"}]},y=window.RTCRtpTransceiver&&"setCodecPreferences"in window.RTCRtpTransceiver.prototype,l=(e,o)=>{let d=window.location.search.substring(1).split("&");for(let s=0;s<d.length;s++){let t=d[s].split("=");if(decodeURIComponent(t[0])==e){let n=decodeURIComponent(t[1]);return o?o(n):n}}},O=async()=>{await navigator.mediaDevices.getUserMedia({audio:!0,video:!0});let e=await navigator.mediaDevices.enumerateDevices(),o=document.getElementById("audio-source"),i=document.getElementById("video-source");for(let d=0;d!==e.length;++d){let s=e[d],t=document.createElement("option");t.value=s.deviceId,s.kind==="audioinput"?(t.text=s.label||`microphone ${o.length+1}`,o.appendChild(t)):s.kind==="videoinput"&&(t.text=s.label||`camera ${i.length+1}`,i.appendChild(t))}},R=e=>{window.parent&&window.parent.postMessage(e,window.location.origin)},w=e=>Boolean(parseInt(e)),J=async()=>{let e=l("room"),o=l("name"),i=l("proc",w),d=parseInt(l("duration"),10),s=l("uid"),t=l("h264",w),n=l("aid"),a=l("vid");if(typeof e=="undefined"||typeof o=="undefined"||typeof i=="undefined"||isNaN(d)||typeof s=="undefined")document.getElementById("placeholder").innerHTML="Invalid parameters";else{if(y&&t){let{codecs:r}=RTCRtpSender.getCapabilities("video");c.preferredCodecs=[...r].sort(({mimeType:u},{mimeType:h})=>u.includes("264")?-1:h.includes("264")?1:0)}c=f(p({},c),{room:e,name:o,proc:i,duration:d,uid:s,audioDeviceId:n,videoDeviceId:a,h264:t});try{await O(),await k()}catch(r){console.error(r),m("error")}}},M=e=>window.navigator.userAgent.includes("Mozilla")?e.split(`\r
`).map(o=>o.startsWith("a=fmtp:111")?o.replace("stereo=1","stereo=0"):o).join(`\r
`):e,P=e=>M(e),m=e=>{c.stream.getTracks().forEach(o=>o.stop()),R(e)},k=async()=>{let e=new RTCPeerConnection(N),o=p({},D);c.audioDeviceId&&(o.audio=f(p({},o.audio),{deviceId:{ideal:c.audioDeviceId}})),c.videoDeviceId&&(o.video=f(p({},o.video),{deviceId:{ideal:c.videoDeviceId}}));let i=await navigator.mediaDevices.getUserMedia(o);i.getTracks().forEach(t=>e.addTrack(t,i)),c.stream=i,y&&c.h264&&e.getTransceivers().find(n=>n.sender&&n.sender.track===i.getVideoTracks()[0]).setCodecPreferences(c.preferredCodecs);let d=window.location.protocol==="https:"?"wss":"ws",s=new WebSocket(`${d}://${window.location.host}/ws`);s.onopen=function(){let{room:t,name:n,proc:a,duration:r,uid:u}=c;console.log({room:t,name:n,proc:a,duration:r,uid:u}),s.send(JSON.stringify({type:"join",payload:JSON.stringify({room:t,name:n,duration:r,uid:u,proc:a})}))},s.onclose=function(t){console.log("[ws] closed"),m("disconnected")},s.onerror=function(t){console.error("[ws] error: "+t.data),m("error")},s.onmessage=async function(t){let n=JSON.parse(t.data);if(!n)return console.error("[ws] can't parse message");if(n.type==="offer"){let a=JSON.parse(n.payload);if(!a)return console.error("[ws] can't parse offer");console.log("[ws] received offer"),e.setRemoteDescription(a);let r=await e.createAnswer();r.sdp=P(r.sdp),e.setLocalDescription(r),s.send(JSON.stringify({type:"answer",payload:JSON.stringify(r)}))}else if(n.type==="candidate"){let a=JSON.parse(n.payload);if(!a)return console.error("[ws] can't parse candidate");console.log("[ws] candidate"),e.addIceCandidate(a)}else n.type==="start"?console.log("[ws] start"):n.type==="finishing"?(console.log("[ws] finishing"),document.getElementById("finishing").classList.remove("d-none")):(n.type.startsWith("error")||n.type==="finish")&&m(n.type)},e.onicecandidate=t=>{!t.candidate||s.send(JSON.stringify({type:"candidate",payload:JSON.stringify(t.candidate)}))},e.ontrack=function(t){let n=document.createElement(t.track.kind);n.id=t.track.id,n.srcObject=t.streams[0],n.autoplay=!0,document.getElementById("placeholder").appendChild(n),t.streams[0].onremovetrack=({track:a})=>{let r=document.getElementById(a.id);r&&r.parentNode.removeChild(r)}}};document.addEventListener("DOMContentLoaded",J);})();
